<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Usuários - Biblioteca Asa Literária</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+JP:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="../static/css/home.css">
  <link rel="stylesheet" href="../static/css/usuarios.css">
  <link rel="icon" type="image/x-icon" href="../static/img/head-removebg-preview.png">
</head>

<body>
  <!-- HEADER igual da HOME -->
  <header class="header">
    <div class="header-left">
      <a id="logoHeader" href="home.html"><img id="logoImage" src="../static/img/logo.png" alt="Logo Asa Literária"></a>
    </div>
    <form id="formBuscaLivro" class="search-form">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="campoBusca" placeholder="Pesquise seu livro..." class="search-box">
        <button type="submit" class="search-button">Buscar</button>
      </div>
    </form>
        <div class="header-right">
          <div class="menu-container">
              <button class="btn" id="menuButton">
                        <span class="icon">
                            <svg viewBox="0 0 175 80" width="40" height="40">
                                <rect width="80" height="15" fill="#f0f0f0" rx="10"></rect>
                                <rect y="30" width="80" height="15" fill="#f0f0f0" rx="10"></rect>
                                <rect y="60" width="80" height="15" fill="#f0f0f0" rx="10"></rect>
                            </svg>
                        </span>
                        <span class="text">MENU</span>
                    </button>
                <ul class="dropdown-menu" id="dropdownMenu"></ul>
            </div>
          </div>
  </header>
  <!-- FIM DO CABEÇALHO -->

  <main>
    <section class="welcome-section" style="margin-bottom: 0;">
      <div class="container">
        <h3 class="welcome-message">Gerenciar Usuários<span id="nomeUsuario" class="user-name"></span></h3>
        <p class="welcome-text">Adicione, pesquise e edite usuários do sistema.</p>
      </div>
    </section>
    <section class="catalog-section" style="background: #fff; box-shadow: none; padding-bottom: 2rem;">
      <div class="container">
        <div class="texto">
          <h1 class="section-title" style="margin-bottom: 1.5rem;">Gerenciar Usuário</h1>
        </div>

        <div class="addusuario" style="margin-bottom: 2rem;">
          <button id="btn-adicionar-usuario" class="btn2">
            <i class="fa fa-user-plus"></i> Adicionar Usuário
          </button>
        </div>

        <div class="table-container">
          <table class="tabela-container" id="tabela-usuarios" border="3">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Nascimento</th>
                <th>Cargo</th>
                <th>Status</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="pagination" style="margin-top: 2rem;">
            <a href="" class="pagination-button" id="pagina-anterior">
              <i class="fas fa-chevron-left"></i> Anterior
            </a>
            <span class="current-page" id="paginaAtual">Página 1</span>
            <a href="" class="pagination-button" id="pagina-proxima">
              Próxima <i class="fas fa-chevron-right"></i>
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal para Adição de Usuário -->
  <div id="modal-adicao">
    <form id="form-adicao">
      <h3>Adicionar Novo Usuário</h3>
      <label for="nome_adicao">Nome:</label>
      <input type="text" id="nome_adicao" required>
      <label for="email_adicao">Email:</label>
      <input type="email" id="email_adicao" required>
      <label for="senha_adicao">Senha:</label>
      <input type="password" id="senha_adicao" required>
      <label for="telefone_adicao">Telefone:</label>
      <input type="text" id="telefone_adicao" onkeyup="handlePhone(event)" required>
      <label for="data_nascimento_adicao">Data de nascimento:</label>
      <input type="date" id="data_nascimento_adicao" required>
      <label for="cargo_adicao">Cargo:</label>
      <select name="cargo_adicao" id="cargo_adicao">
        <option value="Cliente">Cliente</option>
        <option value="Bibliotecário">Bibliotecário</option>
        <option value="ADM">ADM</option>
      </select>
      <label for="status_adicao">Status:</label>
      <select name="status_adicao" id="status_adicao">
        <option value="Ativo">Ativo</option>
        <option value="Inativo">Inativo</option>
      </select>
      <div class="modal-buttons">
        <button type="submit" class="enviar">Adicionar</button>
        <button type="button" id="fechar-modal-adicao">Cancelar</button>
      </div>
    </form>
  </div>

  <!-- FOOTER igual da HOME -->
  <footer class="footer">
    <div class="footer-top">
      <div class="footer-contact">
        <h3>Entre em contato conosco</h3>
        <div class="social-links">
          <a href="https://www.whatsapp.com/?lang=pt_BR" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
          <a href="https://www.instagram.com" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
          <a href="https://br.linkedin.com" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
          <a href="https://x.com/?lang=pt" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
          <a href="https://pt-br.facebook.com" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
        </div>
      </div>
      <div class="footer-info">
        <div class="footer-column">
          <h4>Informações</h4>
          <div class="footer-line"></div>
          <p><i class="fas fa-envelope"></i> asa.literaria@email.com</p>
          <p><i class="fas fa-phone"></i> (18) 99999-9999</p>
        </div>
        <div class="footer-column footer-logo">
          <img id="logoImage2" src="../static/img/logo.png" alt="Logo Asa Literária" class="footer-logo-img">
        </div>
        <div class="footer-column">
          <h4>Localização</h4>
          <div class="footer-line"></div>
          <p><i class="fas fa-map-marker-alt"></i> Birigui - SP</p>
          <p>Rua Exemplo, 123 - Centro</p>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <a href="https://www.google.com.br/?hl=pt-BR">Termos de Uso</a>
      <a href="https://www.google.com.br/?hl=pt-BR">Política de privacidade</a>
      <p>&copy; 2023 Asa Literária. Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
  <script src="../static/dist/owl.carousel.min.js"></script>
  <script src="../static/js/scripts.js"></script>
  <script src="../static/js/seguranca.js" defer></script>
  <script src="../static/js/segurancaBiblio.js" defer></script>
  <script src="../static/js/paginaip.js"></script>

  <!-- ==== MANTENHA TODO O SEU JS ORIGINAL AQUI ABAIXO ==== -->
  <script>
    // Seu JS original de gerenciar usuários começa aqui (não foi removido/alterado):

    function validarEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    $(document).ready(function () {
      const token = localStorage.getItem("token");

      carregarUsuarios();

      $("#btn-adicionar-usuario").click(function () {
        $("#modal-adicao").addClass("ativo");
      });

      $("#fechar-modal-adicao").click(function () {
        $("#modal-adicao").removeClass("ativo");
      });

      // Submissão do formulário de adição
      $("#form-adicao").submit(function (e) {
        e.preventDefault();

        const novoUsuario = {
          nome: $("#nome_adicao").val().trim(),
          email: $("#email_adicao").val().trim(),
          senha: $("#senha_adicao").val().trim(),
          telefone: $("#telefone_adicao").val().trim(),
          data_nascimento: $("#data_nascimento_adicao").val(),
          cargo: $("#cargo_adicao").val(),
          status: $("#status_adicao").val()
        };

        $.ajax({
          method: "POST",
          url: ipPython + "/usuariosadm",
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          data: JSON.stringify(novoUsuario),
          success: function () {
            Swal.fire({
              title: "Sucesso!",
              text: "Usuário adicionado com sucesso.",
              icon: "success"
            });
            $("#modal-adicao").hide();
            $("#form-adicao")[0].reset();
            carregarUsuarios();
          },
          error: function (retorno) {
            Swal.fire({
              title: "Erro!",
              text: JSON.parse(retorno.responseText).error || "Erro ao adicionar usuário.",
              icon: "error"
            });
          }
        });
      });

      function carregarUsuarios() {
        const params = new URLSearchParams(window.location.search);
        var pagina = params.get('pagina');

        if (!pagina) pagina = 1;

        if (pagina == 1) {
          document.getElementById('pagina-anterior').style.display = "none";
        }

        $.ajax({
          method: "GET",
          url: ipPython + "/usuario?pagina=" + pagina,
          headers: {
            'Authorization': 'Bearer ' + token
          },
          success: function (data) {
            var total = data.total_paginas
            var paginaAtual = data.pagina_atual
            var anterior = paginaAtual - 1
            var proxima = paginaAtual + 1

            document.getElementById("pagina-anterior").href = "/templates/GerenciarUsuarios.html?pagina=" + anterior

            document.getElementById("pagina-proxima").href = "/templates/GerenciarUsuarios.html?pagina=" + proxima

            if (paginaAtual >= total) {
              document.getElementById('pagina-proxima').style.display = "none"
            }

            if (paginaAtual > total) {
              document.getElementById('listaLivros').innerHTML = `
                    <p>Usuários não encontrados!</p>
                `;
            }

            document.getElementById("paginaAtual").innerHTML = paginaAtual

            let usuarios = data.usuarios;
            let tabela = $("#tabela-usuarios tbody");
            tabela.empty();

            if (usuarios.length === 0) {
              tabela.append(`<tr><td colspan="8">Usuários não encontrados!</td></tr>`);
              return;
            }

            usuarios.forEach(usuario => {
              let linha = `
                <tr>
                  <td>${usuario.nome}</td>
                  <td>${usuario.email}</td>
                  <td class="tel">${usuario.telefone}</td>
                  <td>${formatarData(usuario.data_nascimento)}</td>
                  <td>${usuario.cargo}</td>
                  <td>${usuario.status}</td>
                  <td>
                    <a href="detalhesUsuario.html?id=${usuario.id_usuario}">
                      <button class="detalhes-btn">Detalhes</button>
                    </a>
                  </td>
                </tr>
              `;
              tabela.append(linha);
            });


            $(".editar-btn").click(function () {
              let id = $(this).data("id");
              let nome = $(this).data("nome");
              let email = $(this).data("email");
              let telefone = $(this).data("telefone");
              let data_nascimento_raw = $(this).data("data_nascimento");
              let data_nascimento = new Date(data_nascimento_raw).toISOString().split("T")[0];
              let cargo = $(this).data("cargo");
              let status = $(this).data("status");

              $("#id_usuario").val(id);
              $("#nome").val(nome);
              $("#email").val(email);
              $("#telefone").val(telefone);
              $("#data_nascimento").val(data_nascimento);
              $("#cargo").val(cargo);
              $("#status").val(status);

              $("#modal-edicao").show();
            });

            $(".excluir-btn").click(function () {
              const id = $(this).data("id");

              Swal.fire({
                title: 'Tem certeza?',
                text: "Essa ação não poderá ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
              }).then((result) => {
                if (result.isConfirmed) {
                  $.ajax({
                    method: "DELETE",
                    url: ipPython + "/usuariosadm/" + id,
                    headers: {
                      'Authorization': 'Bearer ' + token
                    },
                    success: function () {
                      Swal.fire({
                        title: "Excluído!",
                        text: "O usuário foi excluído com sucesso.",
                        icon: "success"
                      });
                      carregarUsuarios();
                    },
                    error: function (retorno) {
                      Swal.fire({
                        title: "Erro!",
                        text: JSON.parse(retorno.responseText).error || "Não foi possível excluir o usuário.",
                        icon: "error"
                      });
                    }
                  });
                }
              });
            });
          },
          error: function (retorno) {
            Swal.fire({
              title: "Erro!",
              text: JSON.parse(retorno.responseText).error,
              icon: "error"
            });
          }
        });
      }

      // Envio do formulário de edição
      $("#form-edicao").submit(function (e) {
        e.preventDefault();

        let id = $("#id_usuario").val();
        let nome = $("#nome").val().trim();
        let email = $("#email").val().trim();
        let telefone = $("#telefone").val().trim();
        let data_nascimento = $("#data_nascimento").val().trim();
        let cargo = $("#cargo").val().trim();
        let status = $("#status").val().trim();

        $.ajax({
          method: "PUT",
          url: ipPython + "/usuariosadm/" + id,
          headers: {
            'Authorization': 'Bearer ' + token
          },
          data: JSON.stringify({
            nome: nome,
            email: email,
            telefone: telefone,
            data_nascimento: data_nascimento,
            cargo: cargo,
            status: status
          }),
          contentType: "application/json",
          success: function () {
            Swal.fire({
              title: "Sucesso!",
              text: "Usuário atualizado com sucesso!",
              icon: "success"
            });
            $("#modal-edicao").hide();
            carregarUsuarios();
          },
          error: function (retorno) {
            Swal.fire({
              title: "Erro!",
              text: JSON.parse(retorno.responseText).error || "Falha ao editar usuário.",
              icon: "error"
            });
          }
        });
      });

      $("#fechar-modal").click(function () {
        $("#modal-edicao").hide();
      });

      $("#telefone, #telefone_adicao").on("keyup", function (event) {
        handlePhone(event);
      });

      const handlePhone = (event) => {
        let input = event.target;
        input.value = phoneMask(input.value);
      };

      const phoneMask = (value) => {
        if (!value) return "";
        value = value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d)/, "($1) $2");
        value = value.replace(/(\d)(\d{4})$/, "$1-$2");
        return value;
      };

      function formatarData(dataISO) {
        if (!dataISO) return "";
        let data = new Date(dataISO);
        data.setDate(data.getDate() + 1);
        let dia = data.getDate().toString().padStart(2, "0");
        let mes = (data.getMonth() + 1).toString().padStart(2, "0");
        let ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }
    });

    function abrirModal(id) {
      document.getElementById('modal-' + id).style.display = 'block';
    }

    function fecharModal(id) {
      document.getElementById('modal-' + id).style.display = 'none';
    }

    window.onclick = function (event) {
      const modais = document.querySelectorAll('.modal');
      modais.forEach(modal => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const relatoriosItem = document.getElementById('relatorios');
      const submenu = relatoriosItem.querySelector('.submenu');
      relatoriosItem.querySelector('.submenu-toggle').addEventListener('click', function () {
        submenu.classList.toggle('show');
      });
    });

    function atualizarLinksRelatorios() {
      const linksRelatorios = {
        relatorioMultas: "/multas_relatorio",
        relatorioLivros: "/livros_relatorio",
        relatorioUsuarios: "/usuarios_relatorio",
        relatorioEmprestimos: "/emprestimos_relatorio"
      };
      for (let id in linksRelatorios) {
        const elemento = document.getElementById(id);
        if (elemento) {
          elemento.href = `${ipPython2}${linksRelatorios[id]}`;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", atualizarLinksRelatorios);

    $(document).ready(function () {
      const token = localStorage.getItem("token");
      let debounceTimeout = null;

      // Função para atualizar a tabela de usuários
      function atualizarTabelaUsuarios(usuarios) {
        let tabela = $("#tabela-usuarios tbody");
        tabela.empty();

        if (!usuarios || usuarios.length === 0) {
          tabela.append(`<tr><td colspan="8">Usuários não encontrados!</td></tr>`);
          return;
        }

        usuarios.forEach(usuario => {
          let linha = `
        <tr>
          <td>${usuario.nome}</td>
          <td>${usuario.email}</td>
          <td class="tel">${usuario.telefone}</td>
          <td>${usuario.data_nascimento}</td>
          <td>${usuario.cargo}</td>
          <td>${usuario.status}</td>
          <td>
            <a href="detalhesUsuario.html?id=${usuario.id_usuario}">
              <button class="detalhes-btn">Detalhes</button>
            </a>
          </td>
        </tr>
      `;
          tabela.append(linha);
        });
      }

      // Função para pesquisar usuários
      function pesquisarUsuarios(termo, pagina = 1) {
        $.ajax({
          method: "GET",
          url: `${ipPython}/pesquisar_usuario?q=${encodeURIComponent(termo)}&pagina=${pagina}`,
          headers: {
            'Authorization': 'Bearer ' + token
          },
          success: function (data) {
            atualizarTabelaUsuarios(data.usuarios);
            $("#paginaAtual").text(data.pagina_atual);
            // Atualize a paginação conforme necessário
          },
          error: function (retorno) {
            atualizarTabelaUsuarios([]);
          }
        });
      }

      // Debounce para evitar requisições em excesso
      $("#campoBusca").on("input", function () {
        const termo = $(this).val().trim();
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(function () {
          if (termo.length === 0) {
            carregarUsuarios(); // função já existente para listar todos
          } else {
            pesquisarUsuarios(termo, 1);
          }
        }, 400); // 400ms de debounce
      });
    });

    $("#campoBusca").closest("form").on("submit", function (e) {
      e.preventDefault(); // Impede o envio do formulário
    });

    $("#campoBusca").on("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault(); // Impede o comportamento padrão do Enter

        const termo = $(this).val().trim();
        if (termo.length === 0) {
          carregarUsuarios();
        } else {
          pesquisarUsuarios(termo, 1);
        }

        $(this).blur(); // Remove o foco do campo de busca
      }
    });
    // Detecta se o usuário limpou o campo de busca
    $("#campoBusca").on("input", function () {
      if ($(this).val().trim() === "") {
        carregarUsuarios(); // Recarrega todos os livros se o campo estiver vazio
      }
    });

    const logoImage = document.getElementById("logoImage");
    logoImage.src = `${ipPython}/static/uploads/logo/logo.png`;

    const logoImage2 = document.getElementById("logoImage2");
    logoImage2.src = `${ipPython}/static/uploads/logo/logo.png`;

    // Logo adaptativo
    const logoExts = ['png', 'jpg', 'jpeg', 'webp'];
    function atualizarLogoSite() {
      let i = 0;
      function tentarProxima() {
        if (i >= logoExts.length) {
          let logoImage = document.getElementById("logoImage");
          let logoImage2 = document.getElementById("logoImage2");
          if (logoImage) logoImage.src = '../static/img/head-removebg-preview.png';
          if (logoImage2) logoImage2.src = '../static/img/head-removebg-preview.png';
          return;
        }
        let url = `${ipPython}/static/uploads/logo/logo.${logoExts[i]}?${Date.now()}`;
        fetch(url).then(resp => {
          if (resp.ok) {
            let logoImage = document.getElementById("logoImage");
            let logoImage2 = document.getElementById("logoImage2");
            if (logoImage) logoImage.src = url;
            if (logoImage2) logoImage2.src = url;
          } else {
            i++;
            tentarProxima();
          }
        });
      }
      tentarProxima();
    }
    document.addEventListener('DOMContentLoaded', atualizarLogoSite);

  </script>
</body>

</html>
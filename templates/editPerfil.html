<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Perfil - Biblioteca Asa Literária</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+JP:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="../static/css/home.css">
    <link rel="stylesheet" href="../static/css/editEstilo.css" />
    <link rel="icon" type="image/x-icon" href="../static/img/head-removebg-preview.png">
    <style>
        /* Garante que o menu-dropdown fique alinhado ao canto */
        .menu-container {
            position: relative;
        }

        .submenu {
            display: none;
        }

        .submenu.show {
            display: block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 180px;
            background: #fff;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            z-index: 999;
            margin-top: 0.5rem;
            padding: 0;
        }

        .dropdown-menu.show {
            display: block;
        }
    </style>
</head>

<body>
    <!-- jQuery deve vir ANTES de qualquer script que usa $ ! -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Outras dependências JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../static/js/paginaip.js"></script>
    <script src="../static/js/scripts.js"></script>
    <script src="../static/js/seguranca.js"></script>
    <script src="../static/js/segurancaADM.js"></script>
    <script src="../static/js/segurancaBiblio.js"></script>
    <script src="menuDropdown.js"></script>
    <header class="header">
        <div class="header-left">
            <a id="logoHeader" href="home.html"><img id="logoImage" src="../static/img/logo.png"
                    alt="Logo Asa Literária"></a>
        </div>
        <form id="formBuscaLivro" class="search-form">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="campoBusca" placeholder="Pesquise seu livro..." class="search-box">
                <a class="search-button" href="catalogo.html"><i class="fa-solid fa-folder-open"></i>
                    <p>Buscar</p>
                </a>
            </div>
        </form>
        <div class="header-right">
            <div class="menu-container">
                <button class="btn" id="menuButton">
                    <span class="icon">
                        <svg viewBox="0 0 175 80" width="40" height="40">
                            <rect width="80" height="15" fill="#f0f0f0" rx="10"></rect>
                            <rect y="30" width="80" height="15" fill="#f0f0f0" rx="10"></rect>
                            <rect y="60" width="80" height="15" fill="#f0f0f0" rx="10"></rect>
                        </svg>
                    </span>
                    <span class="text">MENU</span>
                </button>
                <ul class="dropdown-menu" id="dropdownMenu"></ul>
            </div>
        </div>
    </header>

    <main class="profile-container">
        <div class="profile-header">
            <h1><i class="fas fa-user-edit"></i> Editar Perfil</h1>
            <p>Atualize suas informações pessoais</p>
        </div>

        <div class="profile-content">
            <div class="profile-picture-container">
                <div class="picture-wrapper img_perfil">
                    <img src="../static/img/user.png" class="profile-picture foto_usuario" id="imgPreview" />
                    <div class="picture-overlay">
                        <button class="btn-change-img" id="btnAlterarImagem">
                            <i class="fas fa-camera"></i>
                            <span>Alterar</span>
                        </button>
                    </div>
                </div>
                <input type="file" id="inputImagem" style="display: none;" accept="image/*">
            </div>

            <form id="formCadastroUsuario" class="profile-form formulario">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nome"><i class="fas fa-user"></i> Nome:</label>
                        <input class="inserir" type="text" id="nome" name="nome" placeholder="Seu nome completo"
                            required />
                    </div>
                    <div class="form-group">
                        <label for="email"><i class="fas fa-envelope"></i> Email:</label>
                        <input class="inserir" type="email" id="email" name="email" placeholder="seuemail@email.com"
                            required />
                    </div>
                    <div class="form-group">
                        <label for="telefone"><i class="fas fa-phone"></i> Telefone:</label>
                        <input class="inserir" type="tel" id="telefone" name="telefone" placeholder="(99) 99999-9999"
                            required />
                    </div>
                    <div class="form-group">
                        <label for="data_nascimento"><i class="fas fa-calendar-day"></i> Data de nascimento:</label>
                        <input class="inserir" type="date" id="data_nascimento" name="data_nascimento" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                    <a href="editSenha.html" class="btn-change-password">
                        <i class="fas fa-lock"></i> Alterar Senha
                    </a>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-top">
            <div class="footer-contact">
                <h3>Entre em contato conosco</h3>
                <div class="social-links">
                    <!-- From Uiverse.io by david-mohseni -->
                    <ul class="wrapper">
                        <li class="icon facebook">
                            <span class="tooltip">Facebook</span>
                            <i class="fa-brands fa-facebook-f redes"></i>
                        </li>
                        <li class="icon twitter">
                            <span class="tooltip">Twitter</span>
                            <i class="fa-brands fa-twitter redes"></i>
                        </li>
                        <li class="icon instagram">
                            <span class="tooltip">Instagram</span>
                            <i class="fa-brands fa-instagram redes"></i>
                            </svg>
                        </li>
                        <li class="icon whatsapp">
                            <span class="tooltip">WhatsApp</span>
                            <i class="fa-brands fa-whatsapp redes"></i>
                        </li>
                        <li class="icon linkedin">
                            <span class="tooltip">LinkedIn</span>
                            <i class="fa-brands fa-linkedin-in redes"></i>
                        </li>
                    </ul>
    
                </div>
            </div>
            <div class="footer-info">
                <div class="footer-column">
                    <h4>Informações</h4>
                    <div class="footer-line"></div>
                    <p><i class="fas fa-envelope"></i> asa.literaria@email.com</p>
                    <p><i class="fas fa-phone"></i> (18) 99999-9999</p>
                </div>
                <div class="footer-column footer-logo">
                    <img id="logoImage2" src="../static/img/logo.png" alt="Logo Asa Literária" class="footer-logo-img">
                </div>
                <div class="footer-column">
                    <h4>Localização</h4>
                    <div class="footer-line"></div>
                    <p><i class="fas fa-map-marker-alt"></i> Birigui - SP</p>
                    <p>Rua Exemplo, 123 - Centro</p>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <a href="https://www.google.com.br/?hl=pt-BR">Termos de Uso</a>
            <a href="https://www.google.com.br/?hl=pt-BR">Política de privacidade</a>
            <p>&copy; 2023 Asa Literária. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- SCRIPTS DA PÁGINA -->
    <script>
        $(document).ready(function () {
            // Preenche o nome do usuário (caso queira mostrar)
            function exibirNomeUsuario() {
                const nome = localStorage.getItem('nome');
                if (nome) {
                    $('#nomeUsuario').text(' ' + nome);
                } else {
                    $('#nomeUsuario').text('');
                }
            }
            exibirNomeUsuario();

            // Preenche os campos do usuário
            const id = localStorage.getItem("id_usuario");
            if (id) {
                fetch(ipPython + "/usuarioo/" + id, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem("token")
                    }
                })
                    .then(res => res.json())
                    .then(usuario => {
                        $("#nome").val(usuario.nome || "");
                        $("#email").val(usuario.email || "");
                        $("#telefone").val(usuario.telefone || "");

                        // Corrige formato de data para o input type="date"
                        if (usuario.data_nascimento) {
                            let data = usuario.data_nascimento;
                            // Se vier no formato "Tue, 31 Jul 2001 00:00:00 GMT" ou "2001-07-31T00:00:00.000Z"
                            if (isNaN(data[0])) {
                                const dataObj = new Date(data);
                                const yyyy = dataObj.getUTCFullYear();
                                const mm = String(dataObj.getUTCMonth() + 1).padStart(2, '0');
                                const dd = String(dataObj.getUTCDate()).padStart(2, '0');
                                data = `${yyyy}-${mm}-${dd}`;
                            }
                            // Se vier dd/mm/yyyy
                            if (data.includes('/')) {
                                const partes = data.split('/');
                                data = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                            }
                            $("#data_nascimento").val(data);
                        }

                        // Carrega imagem do perfil (usa localStorage como fallback)
                        const imagemSalva = localStorage.getItem("imagem_usuario");
                        if (imagemSalva && imagemSalva !== "undefined") {
                            $("#imgPreview").attr("src", imagemSalva);
                        } else {
                            $("#imgPreview").attr("src", "../static/img/user.png");
                        }
                    })
                    .catch(erro => {
                        Swal.fire({
                            title: "Erro!",
                            text: "Não foi possível carregar os dados do usuário.",
                            icon: "error"
                        });
                    });
            }

            // Máscara para telefone
            $('#telefone').on('input keyup', function () {
                $(this).val(phoneMask($(this).val()));
            });

            // Atualiza links dos submenus de relatórios
            function atualizarLinksRelatorios() {
                const linksRelatorios = {
                    relatorioMultas: "/multas_relatorio",
                    relatorioLivros: "/livros_relatorio",
                    relatorioUsuarios: "/usuarios_relatorio",
                    relatorioEmprestimos: "/emprestimos_relatorio"
                };
                for (let id in linksRelatorios) {
                    const elemento = document.getElementById(id);
                    if (elemento) {
                        elemento.href = `${ipPython2}${linksRelatorios[id]}`;
                    }
                }
            }
            atualizarLinksRelatorios();

            // Dropdown de relatórios (submenu)
            const relatoriosItem = document.getElementById('relatorios');
            const submenu = relatoriosItem ? relatoriosItem.querySelector('.submenu') : null;
            if (relatoriosItem && submenu) {
                relatoriosItem.querySelector('.submenu-toggle').addEventListener('click', function (e) {
                    e.preventDefault();
                    submenu.classList.toggle('show');
                });
            }
        });

        // Máscara para telefone
        function phoneMask(value) {
            if (!value) return "";
            value = value.replace(/\D/g, "");
            value = value.replace(/(\d{2})(\d)/, "($1) $2");
            value = value.replace(/(\d)(\d{4})$/, "$1-$2");
            return value;
        }

        $("#formCadastroUsuario").on("submit", function (e) {
            e.preventDefault();
            const id = localStorage.getItem("id_usuario");
            if (!id) {
                Swal.fire({
                    title: "Erro!",
                    text: "Usuário não encontrado!",
                    icon: "error"
                });
                return;
            }
            const formData = new FormData(this);
            const fileInput = document.getElementById("inputImagem");
            if (fileInput.files.length > 0) {
                formData.append("imagem", fileInput.files[0]);
            }
            $.ajax({
                method: "PUT",
                url: ipPython + "/usuarios/" + id,
                data: formData,
                contentType: false,
                processData: false,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                },
                success: function (retorno) {
                    // Atualiza os dados no localStorage
                    localStorage.setItem("nome", formData.get("nome"));
                    localStorage.setItem("email", formData.get("email"));
                    localStorage.setItem("telefone", formData.get("telefone"));
                    localStorage.setItem("data_nascimento", formData.get("data_nascimento"));
                    if (fileInput.files.length > 0) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            localStorage.setItem("imagem_usuario", e.target.result);
                            $("#imgPreview").attr("src", e.target.result);
                        };
                        reader.readAsDataURL(fileInput.files[0]);
                    }
                    Swal.fire({
                        title: "Sucesso!",
                        text: "Perfil atualizado com sucesso!",
                        icon: "success"
                    });
                },
                error: function (retorno) {
                    Swal.fire({
                        title: "Erro!",
                        text: JSON.parse(retorno.responseText).error || "Erro ao atualizar perfil",
                        icon: "error"
                    });
                }
            });
        });

        $("#btnAlterarImagem").click(function () {
            $("#inputImagem").click();
        });

        $("#inputImagem").change(function () {
            const file = this.files[0];
            if (!file) {
                Swal.fire({
                    title: "Erro!",
                    text: "Nenhuma imagem selecionada!",
                    icon: "error"
                });
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                $("#imgPreview").attr("src", e.target.result);
            };
            reader.readAsDataURL(file);
        });

        // Logo adaptativo
        const logoExts = ['png', 'jpg', 'jpeg', 'webp'];
        function atualizarLogoSite() {
            let i = 0;
            function tentarProxima() {
                if (i >= logoExts.length) {
                    let logoImage = document.getElementById("logoImage");
                    let logoImage2 = document.getElementById("logoImage2");
                    if (logoImage) logoImage.src = '../static/img/head-removebg-preview.png';
                    if (logoImage2) logoImage2.src = '../static/img/head-removebg-preview.png';
                    return;
                }
                let url = `${ipPython}/static/uploads/logo/logo.${logoExts[i]}?${Date.now()}`;
                fetch(url).then(resp => {
                    if (resp.ok) {
                        let logoImage = document.getElementById("logoImage");
                        let logoImage2 = document.getElementById("logoImage2");
                        if (logoImage) logoImage.src = url;
                        if (logoImage2) logoImage2.src = url;
                    } else {
                        i++;
                        tentarProxima();
                    }
                });
            }
            tentarProxima();
        }
        document.addEventListener('DOMContentLoaded', atualizarLogoSite);
    </script>
</body>

</html>
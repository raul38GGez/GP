<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Perfil - Biblioteca Asa Literária</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+JP:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Corrigido o link do font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="../static/css/editEstilo.css" />
    <link rel="icon" type="image/x-icon" href="../static/img/head-removebg-preview.png">
    <!-- Scripts de segurança -->
    <script src="../static/js/seguranca.js"></script>
    <script src="../static/js/segurancaADM.js"></script>
    <script src="../static/js/segurancaBiblio.js"></script>
</head>

<body>
    <header class="header">
        <!-- Logo -->
        <div class="header-left">
            <a id="logoHeader" href="home.html"><img id="logoImage" src="../static/img/logo.png"
                    alt="Logo Asa Literária"></a>
        </div>
        <!-- Barra de Pesquisa (opcional: pode remover se não quiser!) -->
        <div class="search-container">
            <a href="catalogo.html"><i class="fas fa-search"></i></a>
            <a href="catalogo.html"><button id="campoBusca" class="search-box">Pesquise seu livro</button></a>
        </div>
        <!-- Menu -->
        <div class="header-right">
            <div class="menu-container">
                <div class="menu-icon" id="menuButton">
                    <div class="menulinha"></div>
                    <div class="menulinha"></div>
                    <div class="menulinha"></div>
                </div>
                <ul class="dropdown-menu" id="dropdownMenu">
                    <!-- Itens serão inseridos pelo JavaScript -->
                </ul>
            </div>
        </div>
    </header>

    <main class="profile-container">
        <div class="profile-header">
            <h1><i class="fas fa-user-edit"></i> Editar Perfil</h1>
            <p>Atualize suas informações pessoais</p>
        </div>

        <div class="profile-content">
            <div class="profile-picture-container">
                <div class="picture-wrapper img_perfil">
                    <img src="../static/img/user.png" class="profile-picture foto_usuario" id="imgPreview" />
                    <div class="picture-overlay">
                        <button class="btn-change-img" id="btnAlterarImagem">
                            <i class="fas fa-camera"></i>
                            <span>Alterar</span>
                        </button>
                    </div>
                </div>
                <input type="file" id="inputImagem" style="display: none;" accept="image/*">
            </div>

            <form id="formCadastroUsuario" class="profile-form formulario">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nome"><i class="fas fa-user"></i> Nome:</label>
                        <input class="inserir" type="text" id="nome" name="nome" placeholder="Seu nome completo"
                            required />
                    </div>

                    <div class="form-group">
                        <label for="email"><i class="fas fa-envelope"></i> Email:</label>
                        <input class="inserir" type="email" id="email" name="email" placeholder="seuemail@email.com"
                            required />
                    </div>

                    <div class="form-group">
                        <label for="telefone"><i class="fas fa-phone"></i> Telefone:</label>
                        <input class="inserir" type="tel" id="telefone" name="telefone" placeholder="(99) 99999-9999"
                            required />
                    </div>

                    <div class="form-group">
                        <label for="data_nascimento"><i class="fas fa-calendar-day"></i> Data de nascimento:</label>
                        <input class="inserir" type="date" id="data_nascimento" name="data_nascimento" required>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                    <a href="editSenha.html" class="btn-change-password">
                        <i class="fas fa-lock"></i> Alterar Senha
                    </a>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-top">
            <div class="footer-contact">
                <h3>Entre em contato conosco</h3>
                <div class="social-links">
                    <a href="https://www.whatsapp.com/?lang=pt_BR" aria-label="WhatsApp"><i
                            class="fab fa-whatsapp"></i></a>
                    <a href="https://www.instagram.com" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://br.linkedin.com" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                    <a href="https://x.com/?lang=pt" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://pt-br.facebook.com" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
                </div>
            </div>

            <div class="footer-info">
                <div class="footer-column">
                    <h4>Informações</h4>
                    <div class="footer-line"></div>
                    <p><i class="fas fa-envelope"></i> asa.literaria@email.com</p>
                    <p><i class="fas fa-phone"></i> (18) 99999-9999</p>
                </div>

                <div class="footer-column footer-logo">
                    <a id="logoHeader" href="home.html">
                        <img id="logoImage2" src="../static/img/logo.png" alt="Logo Asa Literária"
                            class="footer-logo-img">
                    </a>
                </div>

                <div class="footer-column">
                    <h4>Localização</h4>
                    <div class="footer-line"></div>
                    <p><i class="fas fa-map-marker-alt"></i> Birigui - SP</p>
                    <p>Rua Exemplo, 123 - Centro</p>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <a href="#">Termos de Uso</a>
            <a href="#">Política de privacidade</a>
            <p>&copy; 2023 Asa Literária. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Scripts principais -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../static/js/paginaip.js"></script>
    <script src="../static/js/scripts.js"></script>
    <script src="../static/js/seguranca.js" defer></script>
    <script>
        // Carrega os dados do usuário do localStorage
        $(document).ready(function () {
            // Carrega dados do usuário
            const nome = localStorage.getItem("nome") || "";
            $("#nome").val(nome);

            const email = localStorage.getItem("email") || "";
            $("#email").val(email);

            const telefone = localStorage.getItem("telefone") || "";
            $("#telefone").val(telefone);

            const dataNascimento = localStorage.getItem("data_nascimento") || "";
            if (dataNascimento) {
                // Corrige o problema da data mostrando um dia antes (ajuste de timezone)
                const dataOriginal = new Date(dataNascimento);
                const dataAjustada = new Date(dataOriginal.getTime() + dataOriginal.getTimezoneOffset() * 60000);
                const dataFormatada = dataAjustada.toISOString().split('T')[0];
                $("#data_nascimento").val(dataFormatada);
            }

            // Carrega imagem do perfil
            const imagemSalva = localStorage.getItem("imagem_usuario");
            if (imagemSalva && imagemSalva !== "undefined") {
                $("#imgPreview").attr("src", imagemSalva);
            } else {
                $("#imgPreview").attr("src", "../static/img/user.png");
            }

            // Máscara para telefone
            $('#telefone').on('input keyup', function () {
                $(this).val(phoneMask($(this).val()));
            });
        });

        // Função de máscara para telefone
        function phoneMask(value) {
            if (!value) return "";
            value = value.replace(/\D/g, "");
            value = value.replace(/(\d{2})(\d)/, "($1) $2");
            value = value.replace(/(\d)(\d{4})$/, "$1-$2");
            return value;
        }

        // Evento de envio do formulário
        $("#formCadastroUsuario").on("submit", function (e) {
            e.preventDefault();

            const id = localStorage.getItem("id_usuario");
            if (!id) {
                Swal.fire({
                    title: "Erro!",
                    text: "Usuário não encontrado!",
                    icon: "error"
                });
                return;
            }

            const formData = new FormData(this);
            const fileInput = document.getElementById("inputImagem");

            if (fileInput.files.length > 0) {
                formData.append("imagem", fileInput.files[0]);
            }

            $.ajax({
                method: "PUT",
                url: ipPython + "/usuarios/" + id,
                data: formData,
                contentType: false,
                processData: false,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("token")
                },
                success: function (retorno) {
                    // Atualiza localStorage
                    localStorage.setItem("nome", formData.get("nome"));
                    localStorage.setItem("email", formData.get("email"));
                    localStorage.setItem("telefone", formData.get("telefone"));
                    localStorage.setItem("data_nascimento", formData.get("data_nascimento"));

                    // Atualiza imagem se foi alterada
                    if (fileInput.files.length > 0) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            localStorage.setItem("imagem_usuario", e.target.result);
                            $("#imgPreview").attr("src", e.target.result);
                        };
                        reader.readAsDataURL(fileInput.files[0]);
                    }

                    Swal.fire({
                        title: "Sucesso!",
                        text: "Perfil atualizado com sucesso!",
                        icon: "success"
                    });
                },
                error: function (retorno) {
                    Swal.fire({
                        title: "Erro!",
                        text: JSON.parse(retorno.responseText).error || "Erro ao atualizar perfil",
                        icon: "error"
                    });
                }
            });
        });

        // Botão para alterar imagem
        $("#btnAlterarImagem").click(function () {
            $("#inputImagem").click();
        });

        // Pré-visualização da imagem
        $("#inputImagem").change(function () {
            const file = this.files[0];
            if (!file) {
                Swal.fire({
                    title: "Erro!",
                    text: "Nenhuma imagem selecionada!",
                    icon: "error"
                });
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                $("#imgPreview").attr("src", e.target.result);
            };
            reader.readAsDataURL(file);
        });

        // Logo adaptativo (igual home)
        const logoExts = ['png', 'jpg', 'jpeg', 'webp'];
        function atualizarLogoSite() {
            let i = 0;
            function tentarProxima() {
                if (i >= logoExts.length) {
                    let logoImage = document.getElementById("logoImage");
                    let logoImage2 = document.getElementById("logoImage2");
                    if (logoImage) logoImage.src = '../static/img/head-removebg-preview.png';
                    if (logoImage2) logoImage2.src = '../static/img/head-removebg-preview.png';
                    return;
                }
                let url = `${typeof ipPython !== "undefined" ? ipPython : ""}/static/uploads/logo/logo.${logoExts[i]}?${Date.now()}`;
                fetch(url).then(resp => {
                    if (resp.ok) {
                        let logoImage = document.getElementById("logoImage");
                        let logoImage2 = document.getElementById("logoImage2");
                        if (logoImage) logoImage.src = url;
                        if (logoImage2) logoImage2.src = url;
                    } else {
                        i++;
                        tentarProxima();
                    }
                });
            }
            tentarProxima();
        }
        document.addEventListener('DOMContentLoaded', atualizarLogoSite);

        // Função para atualizar links de relatórios (caso tenha menu de relatórios)
        function atualizarLinksRelatorios() {
            const linksRelatorios = {
                relatorioMultas: "/multas_relatorio",
                relatorioLivros: "/livros_relatorio",
                relatorioUsuarios: "/usuarios_relatorio",
                relatorioEmprestimos: "/emprestimos_relatorio"
            };
            for (let id in linksRelatorios) {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.href = `${typeof ipPython2 !== "undefined" ? ipPython2 : ""}${linksRelatorios[id]}`;
                }
            }
        }
        document.addEventListener("DOMContentLoaded", atualizarLinksRelatorios);
    </script>
</body>

</html>